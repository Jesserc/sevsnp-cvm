// SPDX-License-Identifier: UNLICENSED

pragma solidity ^0.8.13;

import "forge-std/Test.sol";
import "../src/RsaVerify.sol";
import "../src/RsaVerifyOptimized.sol";

import "./FIPS186_2.sol";
import "./FIPS186_4.sol";
import "./OpenSSL.sol";
import "./RFC8017.sol";

contract RsaVerifyTest is Test {
    function test_suites(
        function(bytes memory, bytes memory, bytes memory, bytes memory)
            returns (bool) _verifier
    ) internal {
        {
            VectorTest[] memory vt = new FIPS186_2().suite();
            for (uint256 i = 0; i < vt.length; i++) {
                assertEq(
                    _verifier(vt[i].Msg, vt[i].S, vt[i].e, vt[i].n),
                    vt[i].pass
                );
            }
        }
        {
            VectorTest[] memory vt = new FIPS186_4().suite();
            for (uint256 i = 0; i < vt.length; i++) {
                assertEq(
                    _verifier(vt[i].Msg, vt[i].S, vt[i].e, vt[i].n),
                    vt[i].pass
                );
            }
        }
        {
            VectorTest[] memory vt = new OpenSSL().suite();
            for (uint256 i = 0; i < vt.length; i++) {
                assertEq(
                    _verifier(vt[i].Msg, vt[i].S, vt[i].e, vt[i].n),
                    vt[i].pass
                );
            }
        }
        {
            VectorTest[] memory vt = new RFC8017().suite();
            for (uint256 i = 0; i < vt.length; i++) {
                assertEq(
                    _verifier(vt[i].Msg, vt[i].S, vt[i].e, vt[i].n),
                    vt[i].pass
                );
            }
        }
    }

    function pkcs1Sha256Raw_original(
        bytes memory Msg,
        bytes memory S,
        bytes memory e,
        bytes memory n
    ) internal view returns (bool) {
        return RsaVerify.pkcs1Sha256Raw(Msg, S, e, n);
    }

    function pkcs1Sha256Raw_optimized(
        bytes memory Msg,
        bytes memory S,
        bytes memory e,
        bytes memory n
    ) internal view returns (bool) {
        return RsaVerifyOptimized.pkcs1Sha256Raw(Msg, S, e, n);
    }

    function test_suites_original() public {
        test_suites(pkcs1Sha256Raw_original);
    }

    function test_suites_optimized() public {
        test_suites(pkcs1Sha256Raw_optimized);
    }

    function test_gas_original() public {
        bytes
            memory e = hex"0000000000000000000000000000000000000000000000000000000000000000"
            hex"0000000000000000000000000000000000000000000000000000000000000000"
            hex"0000000000000000000000000000000000000000000000000000000000000000"
            hex"0000000000000000000000000000000000000000000000000000000000010001";

        bytes
            memory Msg = hex"65794a68624763694f694a53557a49314e694973496d707264534936496d68306448427a4f69387663326868636d566b5a58567a4d69356c64584d794c6d46306447567a64433568656e56795a5335755a5851765932567964484d694c434a72615751694f694a4b4d4842425547526d57466849635664586157316e636b67344e544e3354556c6b614455765a6b786c4d586f3264564e59575642595132457750534973496e523563434936496b705856434a392e65794a6c654841694f6a45334d7a51334e4463344f545173496d6c68644349364d54637a4e4463784f5441354e43776961584e7a496a6f696148523063484d364c79397a614746795a57526c64584d794c6d5631637a4975595852305a584e304c6d463664584a6c4c6d356c64434973496d703061534936496d5a685a575a694d6a6b784f475179596a55334f5449345a4446685954566c4f475a6a4d6d4e684d5467345a44526d4d5441784d5455344d7a52695a47526a4d5441784f44466c4f544935596a45304d6a4131597a55694c434a75596d59694f6a45334d7a51334d546b774f545173496e4e6c593356795a574a76623351694f6e527964575573496e677462584d74595852305a584e30595852706232347464486c775a534936496d463664584a6c646d30694c434a344c57317a4c57463664584a6c646d3074595852305a584e30595852706232347463484a766447396a62327774646d5679496a6f694d693477496977696543317463793168656e56795a585a744c5746306447567a6447566b4c58426a636e4d694f6c73774c4445734d69777a4c4451734e5377324c4464644c434a344c57317a4c57463664584a6c646d3074596d39766447526c596e566e4c57567559574a735a5751694f6d5a6862484e6c4c434a344c57317a4c57463664584a6c646d30745a474a32595778705a4746305a5751694f6e527964575573496e677462584d7459587031636d56326253316b596e6832595778705a4746305a5751694f6e527964575573496e677462584d7459587031636d56326253316b5a574a315a32646c636e4e6b61584e68596d786c5a43493664484a315a5377696543317463793168656e56795a585a744c57526c5a6d4631624851746332566a64584a6c596d39766447746c65584e32595778705a4746305a5751694f6e527964575573496e677462584d7459587031636d56326253316c624746744c57567559574a735a5751694f6d5a6862484e6c4c434a344c57317a4c57463664584a6c646d30745a6d78705a32683063326c6e626d6c755a79316c626d46696247566b496a706d5957787a5a5377696543317463793168656e56795a585a744c57683259326b746347397361574e35496a6f774c434a344c57317a4c57463664584a6c646d307461486c775a584a3261584e76636d526c596e566e4c57567559574a735a5751694f6d5a6862484e6c4c434a344c57317a4c57463664584a6c646d307461584d7464326c755a473933637949365a6d467363325573496e677462584d7459587031636d5632625331725a584a755a57786b5a574a315a79316c626d46696247566b496a706d5957787a5a5377696543317463793168656e56795a585a744c57397a596e5670624751694f694a4f623352426348427361574e6864476c7662694973496e677462584d7459587031636d563262533176633252706333527962794936496c56696457353064534973496e677462584d7459587031636d56326253317663335235634755694f694a4d6157353165434973496e677462584d7459587031636d56326253317663335a6c636e4e706232347462574671623349694f6a49794c434a344c57317a4c57463664584a6c646d307462334e325a584a7a615739754c573170626d3979496a6f304c434a344c57317a4c57463664584a6c646d307463326c6e626d6c755a325270633246696247566b496a7030636e566c4c434a344c57317a4c57463664584a6c646d30746447567a64484e705a323570626d63745a573568596d786c5a4349365a6d467363325573496e677462584d7459587031636d56326253313262576c6b496a6f694f5545304d6b4643524455744f444d344e5330304d6b497a4c546b794e545574526b55334f4441334e6a6b344d546b304969776965433174637931706332397359585270623234746447566c496a7037496e677462584d74595852305a584e30595852706232347464486c775a534936496e4e6c646e4e7563485a7449697769654331746379316a6232317762476c68626d4e6c4c584e305958523163794936496d463664584a6c4c574e7662584273615746756443316a646d30694c434a344c57317a4c584a31626e5270625755694f6e73696132563563794936573373695a534936496b4652515549694c434a725a586c666233427a496a7062496e4e705a3234695853776961326c6b496a6f6953454e4d51577451645749694c434a7264486b694f694a53553045694c434a75496a6f6963445631615764425155464d4d546331525442456545463059544934644539505154464a53315234596e64734d30785861314a4f5a6c5277646d593561307051644331714d576877546b5a615a6e68555a58425259553547536d4a3063564e43635646685548426a4f4749345655564c546a564a6133597854456c6d5330464265455a31526c4a4a5a6d38775a464278614735526444686f5a6930305a7a5243626d30306558517756457833656c4a5955485a744d4842345a6b706854327049516d7877524756685a334e5357446c72556b3556616e466e56576c305558427456445a494d3164784e484d744e336433546c4246555852485a4735685a484e66626d7466646d46364d6e6c4a64545266574574474d6b5574596a645254467036636b315a617a4a734c56673554576c724e45644f567a4e575a314e476330316c546d684a566b5a71646c4676526a4a4d655670455a6e5a56576e6435656a4661525552574d3056564d315a4a4d6e4a335248704554484a4b6446704f4d5639776155464d656b7377536d356b57474e5661554e33575846686248704b53324675583352355a575a58636c685664334e704d48553358314e754d6a597a51336450526b395556586c33496e307365794a6c496a6f695156464251694973496d746c6556397663484d694f6c73695a57356a636e6c7764434a644c434a72615751694f694a49513078466131423159694973496d743065534936496c4a5451534973496d34694f694a335244417a59304642515739735a58593365576c49616c5a585a3170774e444a326144644462545a51656c68516133467a5446685a556d4a4a536b4a3355325650596b5a4456454643523239555556646d617a684a636d6778554768515747566c4d446c7a4d6c4e574e4730335a316c31597a4a445630517a556d553254475133596d525163324d31574546715a6d7734516c426a63444a6952315a69546d4a71556e423453563945635441354e323434533035615231464e6458684c5a47393161326c6e5758566f576d68706458703561456c5956466b3457464a494e4531685957526c4f45464552324a496548465854584a6f6230355057546849564331796330315552454a546545744a61325178513168474e303956656b787654303173596d6878547a526e533064494f485a56616b6c756430786d4d30463562324a6f6458686e62474a6956444e734e6d397661304e4455306b78536b6c7458304a4e51574e714e7a4e66533067315455316c5a476c464d554670627a4e744d575a345544685854577868576e68616555646f5a6d4657647a426d63334254596e4244655856734d324e6d6447397754545a4f516d74785a7a64594d31526662484e324d6b34325533636966563073496e567a5a5849745a47463059534936496a41774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d44417749697769646d3074593239755a6d6c6e64584a6864476c766269493665794a6a6232357a6232786c4c57567559574a735a5751694f6e527964575573496e4e6c593356795a53316962323930496a7030636e566c4c434a30634730745a573568596d786c5a43493664484a315a537769646d3156626d6c786457564a5a434936496a6c424e444a42516b51314c54677a4f4455744e444a434d7930354d6a55314c555a464e7a67774e7a59354f4445354e434a3966537769654331746379317a5a585a7a626e4232625331686458526f62334a725a586c6b6157646c633351694f6949774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441694c434a344c57317a4c584e6c646e4e7563485a744c574a76623352736232466b5a58497463335a75496a6f304c434a344c57317a4c584e6c646e4e7563485a744c575a6862576c7365556c6b496a6f694d4445774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441694c434a344c57317a4c584e6c646e4e7563485a744c5764315a584e3063335a75496a6f334c434a344c57317a4c584e6c646e4e7563485a744c5768766333526b59585268496a6f694d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d434973496e677462584d746332563263323577646d3074615752725a586c6b6157646c633351694f6949774d7a55324d6a45314f446779595467794e5449334f5745344e57497a4d4442694d4749334e4449354d7a466b4d54457a596d59335a544d795a47526c4d6d55314d475a6d5a4755335a574d334e444e6a595451354d57566a5a4751335a6a4d7a4e6d526a4d6a68684e6d5577596a4a69596a5533595759335954513059544d694c434a344c57317a4c584e6c646e4e7563485a744c576c745957646c535751694f6949774d6a41774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d434973496e677462584d746332563263323577646d307461584d745a4756696457646e59574a735a5349365a6d467363325573496e677462584d746332563263323577646d307462474631626d4e6f62575668633356795a57316c626e51694f6949774d7a5a6d597a4979596a55784e7a6b344d5745334f54466d4e325934596a67355a44597a4e4745774d4755354e6a526d4e6d49775a475a68596d4d314e6a67774f54426c596a517a4f544e6b4e6a41794e6d59354e6d46684e6d493359324e684d6a63314f5759794f5755314d6a45304e6a6c6d4d5445344f574d774d474d694c434a344c57317a4c584e6c646e4e7563485a744c57317059334a765932396b5a53317a646d34694f6a49784d537769654331746379317a5a585a7a626e423262533174615764795958527062323474595778736233646c5a4349365a6d467363325573496e677462584d746332563263323577646d3074636d567762334a305a47463059534936496d4a6a5a54686c5a5459315a4451774f544d7859546c694d7a4e6c4d5745794f5467324f574a694d6a4e6b5a6a526b5a4467774f54646d4d444d344f446b345a6a5a694d6d466a596d49304e44566b4d7a6732595455774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d4441774d44417749697769654331746379317a5a585a7a626e4232625331795a584276636e52705a434936496a5a694d7a49304e3251785a54426c4d6d55774e7a4d324d474d784d574a6d59324a695a57466d4d575130596a686b4e444a6a4e544d784d4459774d5755354d474d7a4d6d5669597a5934595456684d545a6c4f4451694c434a344c57317a4c584e6c646e4e7563485a744c584e7464433168624778766432566b496a7030636e566c4c434a344c57317a4c584e6c646e4e7563485a744c584e7563475a334c584e32626949364d6a4573496e677462584d746332563263323577646d30746447566c4c584e32626949364d437769654331746379317a5a585a7a626e42326253313262584273496a6f776653776965433174637931776232787059336b746147467a61434936496e64744f57314962485a55565467795a546856635739506554465a616a4647516c4a54546d746d5a546b354c54593553566c4563546c6c56334d694c434a344c57317a4c584a31626e5270625755694f6e7369593278705a5735304c58426865577876595751694f6e7369626d3975593255694f694969665377696132563563794936573373695a534936496b4652515549694c434a725a586c666233427a496a7062496d567559334a35634851695853776961326c6b496a6f69564842745258426f5a57316c636d46735257356a636e6c7764476c76626b746c65534973496d743065534936496c4a5451534973496d34694f694a3353334531524546425158426c615756705232566c54484e584e315a4e5a4756595956425664554a445956706a5231703554554e5a4e33564f5833463564305677536b773362544a30556d56585a444245633274555a564a614d44557a4e7a51335533466d5a6d316e627a566a6332526c62315178556d746863464e336143317162485a32656d5a6f52444250595659785156526d526b4634545642354d563934566b4e524f476b3263474974646b393665577457636d557a6232465354476c42556d4668643364754d444d794e557374566d686d576b706c59303172556a4535526a4132566a646f64336b3252545a514d545a795630354963554e714e32567862475a61536d5a7061455a42575851784e314a495748705761555a30526a5133636c64305530704b574852444d6c396e526d4d334f5752314e566c7862575a6d59573557554752575a46427761314177625646345533513151564649583078615254647565544e59533352445431465a5533644d6344513064565a575431425763474d774d544649546d7834645773776458524557474a7364476c616432394a55316335636d46754d6b6c6a5a465a615a484a485a546845646b39534e32786d5154564b57486369665631394c434a344c57317a4c585a6c63694936496a45754d434a39";

        bytes
            memory S = hex"599f1005abe5ea518b1bd4c33caf338eb4d29b251e1fd73ce42c35970ece37da8a2ee58d1d3bac64716786989e2c849bf61e4c00dffb11a2ffba2aed3c02bbac8237d196e89246bd850090aa9275f191a8cd9460f7d81f62c3b73c82aab6dee1350c8fe51b3d6d06926d4f2594ac312cfdda5070a32b89509c8076f7e410559dfabaedfddce0531f4c08139e53a5aa52c9ab0842f0e0a067453baf5c67335c40494fa69ef1663735403064a065ba986ddbe2c538695330edeacb21a0fbd4582e1d57e5d10ad605ce78d8cff58e1b1f30968227e23976dbc864fbcc6ff708aff30755bd6fc67cc7f108c94af3431f14d22acfcd50a2211cede585f7278f2a51cf";

        bytes
            memory n = hex"d8d06b1107705d4cd5cb6a7e499eec063c5b55de224c6344409bbf3adfc2d0d0b35c80d3e8330401e5592d2a1659c5baa1743cd61fb2416b70fa3156fd23e01b814648bd549d53bc65a93cd2d868bd093475b643a3ef65b283a739f5df3d42f44fd0201eda89a54af7b427f24512dd0b4320175b40ca365b323f1b1ded99989f462d3253e6ff44d22e65dd2e16658e76bcccd9695a5fc70fb4fece6d4737283c6a88acc3a75ffee4bf98fbb22b2a64a36ae9f3fee0c1ef2dbfed5f21c2916e85cd7f26525c3244dcc13f7478c5a5c1bf293324c6808825bf62bfd3c7271d9e6c2c4d1ee17b543bf2ad762a762a2ef5158e0fefdfdfd158649b16768fd585f91f";

        assertEq(RsaVerify.pkcs1Sha256Raw(Msg, S, e, n), true);
    }

    /*  function test_gas_optimized() public {
        bytes memory e = hex"0000000000000000000000000000000000000000000000000000000000000000"
            hex"0000000000000000000000000000000000000000000000000000000000000000"
            hex"0000000000000000000000000000000000000000000000000000000000000000"
            hex"0000000000000000000000000000000000000000000000000000000000010001";

        bytes memory Msg = bytes("hello world");

        bytes memory S = hex"079bed733b48d69bdb03076cb17d9809072a5a765460bc72072d687dba492afe"
            hex"951d75b814f561f253ee5cc0f3d703b6eab5b5df635b03a5437c0a5c17930981"
            hex"2f5b5c97650361c645bc99f806054de21eb187bc0a704ed38d3d4c2871a117c1"
            hex"9b6da7e9a3d808481c46b22652d15b899ad3792da5419e50ee38759560002388";

        bytes memory n = hex"DF3EDDE009B96BC5B03B48BD73FE70A3AD20EAF624D0DC1BA121A45CC7398937"
            hex"41B7CF82ACF1C91573EC8266538997C6699760148DE57E54983191ECA0176F51"
            hex"8E547B85FE0BB7D9E150DF19EEE734CF5338219C7F8F7B13B39F5384179F62C1"
            hex"35E544CB70BE7505751F34568E06981095AEEC4F3A887639718A3E11D48C240D";

        assertEq(RsaVerifyOptimized.pkcs1Sha256Raw(Msg, S, e, n), true);
    } */
}
